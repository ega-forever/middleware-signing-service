image: docker:latest
stages:
  - build
  - test
  - release
  - stage
  - deploy

variables:
  REGISTRY: gcr.io/deep-wares-144610
  CONTAINER_IMAGE_STAGE: ${REGISTRY}/chronobank/middleware-signing-service/stage/middleware-signing-service:${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}
  CONTAINER_IMAGE_PROD: ${REGISTRY}/chronobank/middleware-signing-service/prod/middleware-signing-service:${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}
  CONTAINER_IMAGE_PROD_LATEST: ${REGISTRY}/chronobank/middleware-signing-service/prod/middleware-signing-service:latest
  CONTAINER_IMAGE_STAGE_LATEST: ${REGISTRY}/chronobank/middleware-signing-service/stage/middleware-signing-service:latest

  #CONTAINER_IMAGE: ${REGISTRY}/chronobank/middleware-eth-laborx:${CI_COMMIT_TAG}

  DOCKER_DRIVER: overlay2

cache:
  untracked: true
  key: "$CI_BUILD_REF_NAME"
  paths:
    - node_modules/

Build:
  stage: build
  image: node:8.11-slim

  variables:
    DOCKER_DRIVER: overlay2

  script:
    - apt update
    - apt install git-all pkg-config libncurses5-dev libssl-dev libnss3-dev libexpat-dev libc6-dev g++ gcc make python -y
    - npm install

  artifacts:
    paths:
      - node_modules/
    expire_in: "3 day"

Tests:
  stage: test
  image: node:8.11-slim

  variables:
    DOCKER_DRIVER: overlay2

  before_script:
    - apt update
    - apt install git-all pkg-config libncurses5-dev libssl-dev libnss3-dev libexpat-dev libc6-dev g++ gcc make python -y
    - npm install


  script:
    #- npm run lint
    ##- npm test -- --coverage
    exit 0

  artifacts:
    paths:
      - node_modules/
    expire_in: "3 day"


Release_Develop:
  stage: release
  image: docker:latest
  variables:
    DOCKER_DRIVER: overlay2

  script:
    - docker login -u _json_key -p "$(cat /gcr-secret/key.json)" https://gcr.io
    - docker build -t ${CONTAINER_IMAGE_STAGE} .
    - docker tag ${CONTAINER_IMAGE_STAGE} ${CONTAINER_IMAGE_STAGE_LATEST}
    - docker push ${CONTAINER_IMAGE_STAGE}
    - docker push ${CONTAINER_IMAGE_STAGE_LATEST}

  only:
    - develop
  #only:
    #- tags

Release_Master:
  stage: release
  image: docker:latest
  variables:
    DOCKER_DRIVER: overlay2

  script:
    - docker login -u _json_key -p "$(cat /gcr-secret/key.json)" https://gcr.io
    - docker build -t ${CONTAINER_IMAGE_PROD} .
    - docker tag ${CONTAINER_IMAGE_PROD} ${CONTAINER_IMAGE_PROD_LATEST}
    - docker push ${CONTAINER_IMAGE_PROD}
    - docker push ${CONTAINER_IMAGE_PROD_LATEST}

  only:
    - prod
  #only:
    #- tags

Deploy_to_STAGE:
  stage: stage
  image: artemkin/helm-gke:1.0
  before_script:

    - gcloud auth activate-service-account --key-file=/gke-secret/key.json
    - gcloud container clusters get-credentials stage --zone us-central1-b --project deep-wares-144610
    - helm init --client-only

  script:
    - helm lint ./charts/middleware-signing-service-stage
    - helm upgrade --install middleware-signing-service-stage -f ./charts/middleware-signing-service-stage/values.yaml ./charts/middleware-signing-service-stage
      --set=image.tag=${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}
      --timeout 900
      --namespace=default
      --wait
      --debug

  only:
    - develop
  #only:
    #- tags


Deploy_to_PROD:
  stage: deploy
  image: artemkin/helm-gke:1.0
  before_script:

    - gcloud auth activate-service-account --key-file=/gke-secret/key.json
    - gcloud container clusters get-credentials production --zone us-central1-b --project deep-wares-144610
    - helm init --client-only

  script:
    - helm lint ./charts/middleware-signing-service-prod
    - helm upgrade --install middleware-signing-service-prod -f ./charts/middleware-signing-service-prod/values.yaml ./charts/middleware-signing-service-prod
      --set=image.tag=${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}
      --timeout 900
      --namespace=default
      --wait
      --debug

  only:
    - prod
  only:
    - tags


#### End